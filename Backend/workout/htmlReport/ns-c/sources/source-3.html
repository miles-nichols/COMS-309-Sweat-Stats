


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > UserService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">coms309.workout.Users</a>
</div>

<h1>Coverage Summary for Class: UserService (coms309.workout.Users)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">UserService</td>
<td class="coverageStat">
  <span class="percent">
    53.1%
  </span>
  <span class="absValue">
    (17/32)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    32.8%
  </span>
  <span class="absValue">
    (44/134)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    48.7%
  </span>
  <span class="absValue">
    (146/300)
  </span>
</td>
</tr>
  <tr>
    <td class="name">UserService$$SpringCGLIB$$0</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    53.1%
  </span>
  <span class="absValue">
    (17/32)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    32.8%
  </span>
  <span class="absValue">
    (44/134)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    48.7%
  </span>
  <span class="absValue">
    (146/300)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package coms309.workout.Users;
&nbsp;
&nbsp;import coms309.workout.CompletedWorkout.CompletedWorkout;
&nbsp;import coms309.workout.CompletedWorkout.CompletedWorkoutRepository;
&nbsp;import coms309.workout.LiftSet.LiftSet;
&nbsp;import coms309.workout.LiftSet.LiftSetRepository;
&nbsp;import coms309.workout.Lifts.Lift;
&nbsp;import coms309.workout.Lifts.LiftRepository;
&nbsp;import coms309.workout.Profile.Profile;
&nbsp;import coms309.workout.Role.Role;
&nbsp;import jakarta.validation.constraints.Null;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.http.converter.json.MappingJackson2HttpMessageConverter;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;import org.springframework.web.bind.annotation.RequestParam;
&nbsp;
&nbsp;import java.time.LocalDate;
&nbsp;import java.util.*;
&nbsp;
&nbsp;@Service
&nbsp;@Transactional
<b class="fc">&nbsp;public class UserService {</b>
&nbsp;    @Autowired
&nbsp;    private LiftSetRepository liftSetRepository;
&nbsp;    @Autowired
&nbsp;    private UserRepository userRepository;
&nbsp;    @Autowired
&nbsp;    private LiftRepository liftRepository;
&nbsp;    @Autowired
&nbsp;    private MappingJackson2HttpMessageConverter mappingJackson2HttpMessageConverter;
&nbsp;    @Autowired
&nbsp;    private CompletedWorkoutRepository completedWorkoutRepository;
&nbsp;
&nbsp;    /**
&nbsp;     * Get all users from the database
&nbsp;     */
&nbsp;    public List&lt;User&gt; getAllUsers() {
<b class="fc">&nbsp;        return userRepository.findAll();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Authenticate user login
&nbsp;     */
&nbsp;    public Map&lt;String, String&gt; authenticateUser(User user) {
<b class="fc">&nbsp;        Map&lt;String, String&gt; result = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;        User existingUser = userRepository.findByUsername(user.getUsername());</b>
&nbsp;
<b class="pc">&nbsp;        if (existingUser != null &amp;&amp; user.getPassword().equals(existingUser.getPassword()) &amp;&amp; existingUser.getStrikes() &lt; 3) {</b>
<b class="pc">&nbsp;            if (user.getProfile() == null) {</b>
<b class="nc">&nbsp;                user.setProfile(new Profile());</b>
&nbsp;            }
<b class="fc">&nbsp;            result.put(&quot;message&quot;, &quot;Login successful&quot;);</b>
<b class="fc">&nbsp;            result.put(&quot;status&quot;, &quot;200&quot;);</b>
<b class="pc">&nbsp;        } else if (existingUser != null &amp;&amp; existingUser.getStrikes() &gt; 2) {</b>
<b class="nc">&nbsp;            result.put(&quot;message&quot;, &quot;Too many strikes&quot;);</b>
<b class="nc">&nbsp;            result.put(&quot;status&quot;, &quot;401&quot;);</b>
<b class="pc">&nbsp;        } else if (existingUser != null) {</b>
<b class="fc">&nbsp;            result.put(&quot;message&quot;, &quot;Login failed&quot;);</b>
<b class="fc">&nbsp;            result.put(&quot;status&quot;, &quot;401&quot;);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            result.put(&quot;message&quot;, &quot;User not found with username: &quot; + user.getUsername());</b>
<b class="nc">&nbsp;            result.put(&quot;status&quot;, &quot;404&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Create a new user
&nbsp;     */
&nbsp;    public Map&lt;String, String&gt; createUser(User user) {
<b class="fc">&nbsp;        Map&lt;String, String&gt; response = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;        User existingUserName = userRepository.findByUsername(user.getUsername());</b>
<b class="fc">&nbsp;        User existingUserEmail = userRepository.findByEmail(user.getEmail());</b>
&nbsp;
<b class="fc">&nbsp;        if (existingUserName != null) {</b>
<b class="fc">&nbsp;            response.put(&quot;message&quot;, &quot;Username already exists&quot;);</b>
<b class="fc">&nbsp;            response.put(&quot;status&quot;, &quot;409&quot;);</b>
<b class="pc">&nbsp;        } else if (existingUserEmail != null) {</b>
<b class="nc">&nbsp;            response.put(&quot;message&quot;, &quot;Email already exists&quot;);</b>
<b class="nc">&nbsp;            response.put(&quot;status&quot;, &quot;409&quot;);</b>
&nbsp;        } else {
<b class="fc">&nbsp;            user.setProfileandUser(new Profile());</b>
<b class="fc">&nbsp;            user.setRole(Role.USER);</b>
<b class="fc">&nbsp;            userRepository.save(user);</b>
<b class="fc">&nbsp;            response.put(&quot;message&quot;, &quot;New User posted correctly&quot;);</b>
<b class="fc">&nbsp;            response.put(&quot;status&quot;, &quot;200&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        return response;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Update user&#39;s email
&nbsp;     */
&nbsp;    public Map&lt;String, String&gt; updateUserEmail(User newUser) {
<b class="fc">&nbsp;        Map&lt;String, String&gt; response = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;        User oldUser = userRepository.findByUsername(newUser.getUsername());</b>
&nbsp;
<b class="pc">&nbsp;        if (oldUser != null) {</b>
<b class="fc">&nbsp;            oldUser.setEmail(newUser.getEmail());</b>
<b class="fc">&nbsp;            userRepository.save(oldUser);</b>
<b class="fc">&nbsp;            response.put(&quot;message&quot;, &quot;Student email was updated successfully: &quot; + newUser.getEmail());</b>
<b class="fc">&nbsp;            response.put(&quot;status&quot;, &quot;200&quot;);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            response.put(&quot;message&quot;, &quot;User not found with username: &quot; + newUser.getUsername());</b>
<b class="nc">&nbsp;            response.put(&quot;status&quot;, &quot;404&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        return response;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Update user&#39;s username
&nbsp;     */
&nbsp;    public Map&lt;String, String&gt; updateUsername(User newUser) {
<b class="nc">&nbsp;        Map&lt;String, String&gt; response = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        User oldUser = userRepository.findByEmail(newUser.getEmail());</b>
&nbsp;
<b class="nc">&nbsp;        if (oldUser != null) {</b>
<b class="nc">&nbsp;            oldUser.setUsername(newUser.getUsername());</b>
<b class="nc">&nbsp;            userRepository.save(oldUser);</b>
<b class="nc">&nbsp;            response.put(&quot;message&quot;, &quot;User username was updated successfully: &quot; + newUser.getUsername());</b>
<b class="nc">&nbsp;            response.put(&quot;status&quot;, &quot;200&quot;);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            response.put(&quot;message&quot;, &quot;User not found with email: &quot; + newUser.getEmail());</b>
<b class="nc">&nbsp;            response.put(&quot;status&quot;, &quot;404&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return response;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Update user&#39;s password
&nbsp;     */
&nbsp;    public Map&lt;String, String&gt; updatePassword(User newUser) {
<b class="nc">&nbsp;        Map&lt;String, String&gt; response = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        User oldUser = userRepository.findByEmailAndUsername(newUser.getEmail(), newUser.getUsername());</b>
&nbsp;
<b class="nc">&nbsp;        if (oldUser != null) {</b>
<b class="nc">&nbsp;            oldUser.setPassword(newUser.getPassword());</b>
<b class="nc">&nbsp;            userRepository.save(oldUser);</b>
<b class="nc">&nbsp;            response.put(&quot;message&quot;, &quot;User password was updated successfully: &quot; + newUser.getPassword());</b>
<b class="nc">&nbsp;            response.put(&quot;status&quot;, &quot;200&quot;);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            response.put(&quot;message&quot;, &quot;User not found with email: &quot; + newUser.getEmail() + &quot; and Username: &quot; + newUser.getUsername());</b>
<b class="nc">&nbsp;            response.put(&quot;status&quot;, &quot;404&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return response;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Delete user by username
&nbsp;     */
&nbsp;    public Map&lt;String, String&gt; deleteUser(String username) {
<b class="fc">&nbsp;        Map&lt;String, String&gt; response = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;        User user = userRepository.findByUsername(username);</b>
&nbsp;
<b class="pc">&nbsp;        if (user != null) {</b>
<b class="fc">&nbsp;            userRepository.deleteByUsername(username);</b>
<b class="fc">&nbsp;            response.put(&quot;message&quot;, &quot;User deleted successfully&quot;);</b>
<b class="fc">&nbsp;            response.put(&quot;status&quot;, &quot;200&quot;);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            response.put(&quot;message&quot;, &quot;User not found with username: &quot; + username);</b>
<b class="nc">&nbsp;            response.put(&quot;status&quot;, &quot;404&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        return response;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Search users by partial username
&nbsp;     */
&nbsp;    public List&lt;User&gt; searchUsers(String partUsername) {
<b class="nc">&nbsp;        return userRepository.findByUsernameStartingWith(partUsername);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Handle user following another user
&nbsp;     */
&nbsp;    public Map&lt;String, String&gt; followUser(String followerUsername, String followingUsername) {
<b class="fc">&nbsp;        Map&lt;String, String&gt; response = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;        User follower = userRepository.findByUsername(followerUsername);</b>
<b class="fc">&nbsp;        User following = userRepository.findByUsername(followingUsername);</b>
&nbsp;
<b class="pc">&nbsp;        if (follower == null || following == null) {</b>
<b class="nc">&nbsp;            response.put(&quot;message&quot;, &quot;One or both users not found&quot;);</b>
<b class="nc">&nbsp;            response.put(&quot;status&quot;, &quot;404&quot;);</b>
<b class="nc">&nbsp;            return response;</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        if (following.getFollowers().contains(follower)) {</b>
<b class="nc">&nbsp;            response.put(&quot;message&quot;, followerUsername + &quot; is already following &quot; + followingUsername);</b>
<b class="nc">&nbsp;            response.put(&quot;status&quot;, &quot;409&quot;);</b>
<b class="nc">&nbsp;            return response;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        following.getFollowers().add(follower);</b>
<b class="fc">&nbsp;        follower.getFollowing().add(following);</b>
<b class="fc">&nbsp;        userRepository.save(following);</b>
<b class="fc">&nbsp;        userRepository.save(follower);</b>
&nbsp;
<b class="pc">&nbsp;        if (following.isFriend(follower)) {</b>
<b class="nc">&nbsp;            following.getFriends().add(follower);</b>
<b class="nc">&nbsp;            follower.getFriends().add(following);</b>
<b class="nc">&nbsp;            userRepository.save(following);</b>
<b class="nc">&nbsp;            userRepository.save(follower);</b>
<b class="nc">&nbsp;            response.put(&quot;message&quot;, &quot;Users are now friends&quot;);</b>
&nbsp;        } else {
<b class="fc">&nbsp;            response.put(&quot;message&quot;, &quot;Follow successful&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        response.put(&quot;status&quot;, &quot;200&quot;);</b>
<b class="fc">&nbsp;        return response;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Handle user unfollowing another user
&nbsp;     */
&nbsp;    public Map&lt;String, String&gt; unfollowUser(String followerUsername, String followingUsername) {
<b class="fc">&nbsp;        Map&lt;String, String&gt; response = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;        User follower = userRepository.findByUsername(followerUsername);</b>
<b class="fc">&nbsp;        User following = userRepository.findByUsername(followingUsername);</b>
&nbsp;
<b class="pc">&nbsp;        if (follower == null || following == null) {</b>
<b class="nc">&nbsp;            response.put(&quot;message&quot;, &quot;One or both users not found&quot;);</b>
<b class="nc">&nbsp;            response.put(&quot;status&quot;, &quot;404&quot;);</b>
<b class="nc">&nbsp;            return response;</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        if (!follower.isFollowing(following)) {</b>
<b class="nc">&nbsp;            response.put(&quot;message&quot;, &quot;User: &quot; + follower.getUsername() + &quot; is not following User: &quot; + following.getUsername());</b>
<b class="nc">&nbsp;            response.put(&quot;status&quot;, &quot;409&quot;);</b>
<b class="nc">&nbsp;            return response;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        follower.getFollowing().remove(following);</b>
<b class="fc">&nbsp;        following.getFollowers().remove(follower);</b>
<b class="fc">&nbsp;        follower.getFriends().remove(following);</b>
<b class="fc">&nbsp;        following.getFriends().remove(follower);</b>
<b class="fc">&nbsp;        userRepository.save(follower);</b>
<b class="fc">&nbsp;        userRepository.save(following);</b>
&nbsp;
<b class="fc">&nbsp;        response.put(&quot;message&quot;, &quot;Successfully unfollowed&quot;);</b>
<b class="fc">&nbsp;        response.put(&quot;status&quot;, &quot;200&quot;);</b>
<b class="fc">&nbsp;        return response;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Get user by username
&nbsp;     */
&nbsp;    public User getUserByUsername(String username) {
<b class="fc">&nbsp;        return userRepository.findByUsername(username);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Get user&#39;s friends
&nbsp;     */
&nbsp;    public Set&lt;User&gt; getUserFriends(String username) {
<b class="fc">&nbsp;        User user = userRepository.findByUsername(username);</b>
<b class="pc">&nbsp;        return user != null ? user.getFriends() : new HashSet&lt;&gt;();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Get user&#39;s followers
&nbsp;     */
&nbsp;    public Set&lt;User&gt; getUserFollowers(String username) {
<b class="nc">&nbsp;        User user = userRepository.findByUsername(username);</b>
<b class="nc">&nbsp;        return user != null ? user.getFollowers() : new HashSet&lt;&gt;();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Get users that user is following
&nbsp;     */
&nbsp;    public Set&lt;User&gt; getUserFollowing(String username) {
<b class="nc">&nbsp;        User user = userRepository.findByUsername(username);</b>
<b class="nc">&nbsp;        return user != null ? user.getFollowing() : new HashSet&lt;&gt;();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns specified liftSets from list of CompletedWorkouts
&nbsp;     */
&nbsp;    public List&lt;LiftSet&gt; getLiftFromCompletedWorkout(List&lt;CompletedWorkout&gt; completedWorkouts, Lift l) {
<b class="fc">&nbsp;        List&lt;LiftSet&gt; liftSets = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;        for(CompletedWorkout w: completedWorkouts){</b>
<b class="fc">&nbsp;            liftSets.addAll(w.getLifts(l));</b>
&nbsp;        }
<b class="fc">&nbsp;        return liftSets;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns specified liftSets from list of CompletedWorkouts
&nbsp;     */
&nbsp;    public List&lt;LiftSet&gt; getLiftsFromCompletedWorkout(List&lt;CompletedWorkout&gt; completedWorkouts, List&lt;Lift&gt; list) {
<b class="nc">&nbsp;        List&lt;LiftSet&gt; liftSets = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for(CompletedWorkout w: completedWorkouts){</b>
<b class="nc">&nbsp;            for(Lift l: list)</b>
<b class="nc">&nbsp;                liftSets.addAll(w.getLifts(l));</b>
&nbsp;        }
<b class="nc">&nbsp;        return liftSets;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns a map with lift names as keys and the values as a list of all sets that are done of that lift
&nbsp;     */
&nbsp;    public Map&lt;String, List&lt;coms309.workout.Set.Set&gt;&gt; filterLiftsByMuscleGroup(List&lt;CompletedWorkout&gt; workouts, String muscleGroup){
<b class="nc">&nbsp;        List&lt;LiftSet&gt; hold = new ArrayList&lt;&gt;();</b>
&nbsp;        //filter out not in muscleGroup
<b class="nc">&nbsp;        HashMap&lt;String, List&lt;coms309.workout.Set.Set&gt;&gt; ret = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        for(CompletedWorkout w: workouts){</b>
<b class="nc">&nbsp;            for(LiftSet l: w.getCompletedSets()) {</b>
<b class="nc">&nbsp;                if (l.getLift().getMuscleGroup().equals(muscleGroup)) {</b>
<b class="nc">&nbsp;                    hold.add(l);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        List&lt;coms309.workout.Set.Set&gt; s = new ArrayList&lt;&gt;();</b>
&nbsp;        //put into map
<b class="nc">&nbsp;        for(LiftSet l: hold) {</b>
<b class="nc">&nbsp;            if (!ret.containsKey(l.getLift().getTitle())) {</b>
&nbsp;                ;
<b class="nc">&nbsp;                ret.put(l.getLift().getTitle(), l.getSets());</b>
&nbsp;            } else {
<b class="nc">&nbsp;                ret.get(l.getLift().getTitle()).addAll(l.getSets());</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return ret;</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * return list of lifts that are in both maps
&nbsp;     */
&nbsp;    public List&lt;String&gt; findCommonLifts(Map&lt;String, List&lt;coms309.workout.Set.Set&gt;&gt; t1, Map&lt;String, List&lt;coms309.workout.Set.Set&gt;&gt; t2){
<b class="nc">&nbsp;        List&lt;String&gt; ret = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for(String title: t1.keySet()){</b>
<b class="nc">&nbsp;            if(t2.containsKey(title)){</b>
<b class="nc">&nbsp;                ret.add(title);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        for(String title: ret){</b>
&nbsp;        }
<b class="nc">&nbsp;        return ret;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * calculates the average One Rep Max from a list of LiftSets
&nbsp;     */
&nbsp;    public double computeAverageTopORM(List&lt;LiftSet&gt; ls){
<b class="fc">&nbsp;        int count = 0;</b>
<b class="fc">&nbsp;        double sum = 0.0;</b>
<b class="fc">&nbsp;        for(LiftSet l: ls) {</b>
<b class="fc">&nbsp;            if (l.getSets().isEmpty()) {</b>
&nbsp;                continue;
&nbsp;            } else {
<b class="fc">&nbsp;                sum += l.findBestSet().calculateOneRepMax();</b>
<b class="fc">&nbsp;                count++;</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        if(count&lt;=0) {</b>
<b class="fc">&nbsp;            return -1;</b>
&nbsp;        }
<b class="fc">&nbsp;        return sum/count;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * calculates the average One Rep Max from a list of LiftSets
&nbsp;     */
&nbsp;    public double computeAverageOverallORM(List&lt;coms309.workout.Set.Set&gt; s){
<b class="nc">&nbsp;        int count = 0;</b>
<b class="nc">&nbsp;        double sum = 0.0;</b>
<b class="nc">&nbsp;        for(coms309.workout.Set.Set l: s) {</b>
<b class="nc">&nbsp;            sum += l.calculateOneRepMax();</b>
<b class="nc">&nbsp;            count++;</b>
&nbsp;        }
<b class="nc">&nbsp;        if(count&lt;=0) {</b>
<b class="nc">&nbsp;            return -1;</b>
&nbsp;        }
<b class="nc">&nbsp;        return sum/count;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Compare a users progress on a lift over time
&nbsp;     */
&nbsp;    public Map&lt;String, Object&gt; compareUserLifts(String tf1s, String tf1e, String tf2s, String tf2e, String liftName, String username) {
<b class="fc">&nbsp;        Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();</b>
&nbsp;
&nbsp;        // Early validation with direct returns
<b class="fc">&nbsp;        User user = userRepository.findByUsername(username);</b>
<b class="pc">&nbsp;        if (user == null) {</b>
<b class="nc">&nbsp;            return createErrorResult(&quot;404&quot;, &quot;User not found&quot;, liftName);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        Lift lift = liftRepository.findByTitle(liftName);</b>
<b class="pc">&nbsp;        if (lift == null) {</b>
<b class="nc">&nbsp;            return createErrorResult(&quot;404&quot;, &quot;Lift not found&quot;, liftName);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Parse dates once
<b class="fc">&nbsp;        LocalDate timeframeOneStart = LocalDate.parse(tf1s);</b>
<b class="fc">&nbsp;        LocalDate timeframeOneEnd = LocalDate.parse(tf1e);</b>
<b class="fc">&nbsp;        LocalDate timeframeTwoStart = LocalDate.parse(tf2s);</b>
<b class="fc">&nbsp;        LocalDate timeframeTwoEnd = LocalDate.parse(tf2e);</b>
&nbsp;
&nbsp;        // Get workouts for specific timeframes in a single method call
<b class="fc">&nbsp;        List&lt;CompletedWorkout&gt; rangeOneWorkouts = user.getCompletedWorkoutsBetweenDates(timeframeOneStart, timeframeOneEnd);</b>
<b class="fc">&nbsp;        List&lt;CompletedWorkout&gt; rangeTwoWorkouts = user.getCompletedWorkoutsBetweenDates(timeframeTwoStart, timeframeTwoEnd);</b>
&nbsp;
&nbsp;        // Get lift sets efficiently
<b class="fc">&nbsp;        List&lt;LiftSet&gt; rangeOneLiftSets = getLiftFromCompletedWorkout(rangeOneWorkouts, lift);</b>
<b class="fc">&nbsp;        List&lt;LiftSet&gt; rangeTwoLiftSets = getLiftFromCompletedWorkout(rangeTwoWorkouts, lift);</b>
&nbsp;
&nbsp;        // Check lift set availability with early returns
<b class="pc">&nbsp;        if (rangeOneLiftSets.isEmpty()) {</b>
<b class="nc">&nbsp;            return createErrorResult(&quot;404&quot;, &quot;User hasn&#39;t done lift in earlier timeframe&quot;, liftName);</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        if (rangeTwoLiftSets.isEmpty()) {</b>
<b class="nc">&nbsp;            return createErrorResult(&quot;404&quot;, &quot;User hasn&#39;t done lift in later timeframe&quot;, liftName);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Compute ORMs
<b class="fc">&nbsp;        double firstORM = computeAverageTopORM(rangeOneLiftSets);</b>
<b class="fc">&nbsp;        double secondORM = computeAverageTopORM(rangeTwoLiftSets);</b>
&nbsp;
&nbsp;        // Validate ORM calculation
<b class="fc">&nbsp;        if (firstORM &lt; 0 || secondORM &lt; 0) {</b>
<b class="fc">&nbsp;            return createErrorResult(&quot;404&quot;, &quot;User hasn&#39;t done any sets of this workout&quot;, liftName);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Compute and return progress
<b class="fc">&nbsp;        double progressPercentage = (secondORM - firstORM) / firstORM;</b>
&nbsp;
<b class="fc">&nbsp;        result.put(&quot;status&quot;, &quot;200&quot;);</b>
<b class="fc">&nbsp;        result.put(&quot;message&quot;, &quot;Progress recorded successfully&quot;);</b>
<b class="fc">&nbsp;        result.put(&quot;comparison&quot;, progressPercentage);</b>
<b class="fc">&nbsp;        result.put(&quot;liftName&quot;, liftName);</b>
&nbsp;
<b class="fc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    // Helper method to create consistent error results
&nbsp;    private Map&lt;String, Object&gt; createErrorResult(String status, String message, String liftName) {
<b class="fc">&nbsp;        Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;        result.put(&quot;status&quot;, status);</b>
<b class="fc">&nbsp;        result.put(&quot;message&quot;, message);</b>
<b class="fc">&nbsp;        result.put(&quot;comparison&quot;, 0.0);</b>
<b class="fc">&nbsp;        result.put(&quot;liftName&quot;, liftName);</b>
<b class="fc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Map&lt;String, Object&gt; compareUserMuscleGroup(String tf1s, String tf1e, String tf2s, String tf2e, String muscleGroup, String username){
<b class="fc">&nbsp;        Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;        System.out.println(&quot;create result&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        List&lt;String&gt; lifts = completedWorkoutRepository.getLiftsByUserInTwoRangeByMuscleGroup(username, tf1s, tf1e, tf2s, tf2e, muscleGroup);</b>
<b class="fc">&nbsp;        System.out.println(&quot;after lifts&quot;);</b>
&nbsp;
&nbsp;        double tf1EstimatedORM;
&nbsp;        double tf2EstimatedORM;
<b class="fc">&nbsp;        System.out.println(&quot;make estORM&quot;);</b>
<b class="fc">&nbsp;        List&lt;Double&gt; ormGrowth = new ArrayList&lt;&gt;();</b>
<b class="pc">&nbsp;        for(String liftTitle: lifts) {</b>
<b class="nc">&nbsp;            tf1EstimatedORM = this.computeAverageTopORM(liftSetRepository.getLiftSetsByUserAndLiftTitleInRange(username, tf1s, tf1e, liftTitle));</b>
<b class="nc">&nbsp;            tf2EstimatedORM = this.computeAverageTopORM(liftSetRepository.getLiftSetsByUserAndLiftTitleInRange(username, tf2s, tf2e, liftTitle));</b>
<b class="nc">&nbsp;            ormGrowth.add((tf2EstimatedORM-tf1EstimatedORM)/tf1EstimatedORM);</b>
&nbsp;        }
<b class="fc">&nbsp;        System.out.println(&quot;add ORM TO LIFT&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        double sum = 0;</b>
<b class="pc">&nbsp;        if(ormGrowth.isEmpty()) {</b>
<b class="fc">&nbsp;            result.put(&quot;status&quot;, &quot;404&quot;);</b>
<b class="fc">&nbsp;            result.put(&quot;message&quot;, &quot;User has no lifts that occur in both timeframes for this muscle group&quot;);</b>
<b class="fc">&nbsp;            result.put(&quot;comparison&quot;, 0.0);</b>
<b class="fc">&nbsp;            result.put(&quot;muscleGroup&quot;, muscleGroup);</b>
&nbsp;        }else{
<b class="nc">&nbsp;            for(double d: ormGrowth) {</b>
<b class="nc">&nbsp;                sum+=d;</b>
&nbsp;            }
<b class="nc">&nbsp;            result.put(&quot;status&quot;, &quot;200&quot;);</b>
<b class="nc">&nbsp;            result.put(&quot;message&quot;, &quot;Successfully computed average growth&quot;);</b>
<b class="nc">&nbsp;            result.put(&quot;comparison&quot;, sum/ormGrowth.size());</b>
<b class="nc">&nbsp;            result.put(&quot;muscleGroup&quot;, muscleGroup);</b>
&nbsp;        }
<b class="fc">&nbsp;        return result;</b>
&nbsp;
&nbsp;
&nbsp;
&nbsp;//        Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();
&nbsp;//        User user = userRepository.findByUsername(username);
&nbsp;//        if(user == null){
&nbsp;//            result.put(&quot;status&quot;, &quot;404&quot;);
&nbsp;//            result.put(&quot;message&quot;, &quot;User not found&quot;);
&nbsp;//            result.put(&quot;muscleGroup&quot;, muscleGroup);
&nbsp;//
&nbsp;//        } else {
&nbsp;//            List&lt;CompletedWorkout&gt; rangeOneWorkouts = user.getCompletedWorkoutsBetweenDates(LocalDate.parse(tf1s), LocalDate.parse(tf1e));
&nbsp;//            List&lt;CompletedWorkout&gt; rangeTwoWorkouts = user.getCompletedWorkoutsBetweenDates(LocalDate.parse(tf2s), LocalDate.parse(tf2e));
&nbsp;//            Map&lt;String, List&lt;coms309.workout.Set.Set&gt;&gt; t1 = filterLiftsByMuscleGroup(rangeOneWorkouts, muscleGroup);
&nbsp;//            Map&lt;String, List&lt;coms309.workout.Set.Set&gt;&gt; t2 = filterLiftsByMuscleGroup(rangeTwoWorkouts, muscleGroup);
&nbsp;//            List&lt;String&gt; commonLifts = findCommonLifts(t1, t2);
&nbsp;//            if(commonLifts.isEmpty()){
&nbsp;//                result.put(&quot;status&quot;, &quot;404&quot;);
&nbsp;//                result.put(&quot;message&quot;, &quot;User has no lifts that occur in both timeframes&quot;);
&nbsp;//                result.put(&quot;comparison&quot;, 0.0);
&nbsp;//                result.put(&quot;muscleGroup&quot;, muscleGroup);
&nbsp;//            }else{
&nbsp;//                double sum = 0.0;
&nbsp;//                int count = 0;
&nbsp;//                double firstORM = 0;
&nbsp;//                double secondORM = 0;
&nbsp;//                for(String lift: commonLifts){
&nbsp;//                    firstORM =computeAverageOverallORM(t1.get(lift));
&nbsp;//                    secondORM =computeAverageOverallORM(t2.get(lift));
&nbsp;//                    sum += (secondORM - firstORM)/firstORM;
&nbsp;//                    System.out.println(lift + &quot; &quot; +firstORM);
&nbsp;//                    System.out.println(lift + &quot; &quot; +secondORM);
&nbsp;//                    count++;
&nbsp;//                }
&nbsp;//                if(count==0){
&nbsp;//                    result.put(&quot;status&quot;, &quot;404&quot;);
&nbsp;//                    result.put(&quot;message&quot;, &quot;User has no lifts that occur in both timeframes&quot;);
&nbsp;//                    result.put(&quot;comparison&quot;, 0.0);
&nbsp;//                    result.put(&quot;muscleGroup&quot;, muscleGroup);
&nbsp;//
&nbsp;//                }else{
&nbsp;//                    result.put(&quot;status&quot;, &quot;200&quot;);
&nbsp;//                    result.put(&quot;message&quot;, &quot;progress recorded successfully&quot;);
&nbsp;//                    result.put(&quot;comparison&quot;, sum/count);
&nbsp;//                    result.put(&quot;muscleGroup&quot;, muscleGroup);
&nbsp;//                }
&nbsp;//            }
&nbsp;//        }
&nbsp;//        System.out.println(&quot;done&quot;);
&nbsp;//        return result;
&nbsp;    }
&nbsp;    /**
&nbsp;     * Gets a user&#39;s best real one rep max for a particular lift
&nbsp;     */
&nbsp;    public Map&lt;String, Object&gt; getUserMax(String username, String liftTitle){
<b class="fc">&nbsp;        Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;        result.put(&quot;liftName&quot;, liftTitle);</b>
<b class="fc">&nbsp;        result.put(&quot;maxWeight&quot;, completedWorkoutRepository.getMaxByUserAndContainsKey(username, liftTitle));</b>
<b class="pc">&nbsp;        if(result.get(&quot;maxWeight&quot;)==null){</b>
<b class="nc">&nbsp;            result.put(&quot;status&quot;, &quot;404&quot;);</b>
<b class="nc">&nbsp;            result.put(&quot;message&quot;, &quot;User has no max weight&quot;);</b>
<b class="pc">&nbsp;        }else if(((Double) (result.get(&quot;maxWeight&quot;)))&lt;=0){</b>
<b class="nc">&nbsp;            result.put(&quot;status&quot;, &quot;404&quot;);</b>
<b class="nc">&nbsp;            result.put(&quot;message&quot;, &quot;No lifts found for user&quot;);</b>
&nbsp;        }else{
<b class="fc">&nbsp;            result.put(&quot;status&quot;, &quot;200&quot;);</b>
<b class="fc">&nbsp;            result.put(&quot;message&quot;, &quot;Lifts found for user&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    public CompletedWorkout getLastWorkout(String username){
&nbsp;
<b class="fc">&nbsp;        User u = userRepository.findByUsername(username);</b>
<b class="fc">&nbsp;        List&lt;CompletedWorkout&gt; workouts = u.getCompletedWorkouts();</b>
<b class="fc">&nbsp;        int index = 0;</b>
<b class="pc">&nbsp;        if (workouts.size()==0 ){</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }else {
<b class="pc">&nbsp;            for(int i = workouts.size()-1; i&gt;=0; i--){</b>
<b class="pc">&nbsp;                if(!(workouts.get(i).getDate().isAfter(LocalDate.now()))){</b>
<b class="fc">&nbsp;                    index = i;</b>
&nbsp;                    break;
&nbsp;                }
&nbsp;            }
<b class="fc">&nbsp;            return workouts.get(index);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public Role getUserRole(String username)
&nbsp;    {
<b class="nc">&nbsp;        User u = userRepository.findByUsername(username);</b>
<b class="nc">&nbsp;        return u.getRole();</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getMostPopularLift(String username, String tf1s, String tf1e, String tf2s, String tf2e){
<b class="nc">&nbsp;        User u = userRepository.findByUsername(username);</b>
<b class="nc">&nbsp;        Map&lt;String, Integer&gt; tf1liftCounter = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        Map&lt;String, Integer&gt; tf2liftCounter = new HashMap&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;CompletedWorkout&gt; rangeOneWorkouts = u.getCompletedWorkoutsBetweenDates(LocalDate.parse(tf1s), LocalDate.parse(tf1e));</b>
<b class="nc">&nbsp;        List&lt;CompletedWorkout&gt; rangeTwoWorkouts = u.getCompletedWorkoutsBetweenDates(LocalDate.parse(tf2s), LocalDate.parse(tf2e));</b>
&nbsp;
<b class="nc">&nbsp;        for(CompletedWorkout w: rangeOneWorkouts){</b>
<b class="nc">&nbsp;            for(LiftSet ls: w.getCompletedSets()){</b>
<b class="nc">&nbsp;                if(ls.getSets().isEmpty()){</b>
&nbsp;                    continue;
&nbsp;                }else {
<b class="nc">&nbsp;                    if (tf1liftCounter.containsKey(ls.getLift().getTitle())) {</b>
<b class="nc">&nbsp;                        tf1liftCounter.put(ls.getLift().getTitle(), tf1liftCounter.get(ls.getLift().getTitle()) + 1);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        tf1liftCounter.put(ls.getLift().getTitle(), 1);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        for(CompletedWorkout w: rangeTwoWorkouts){</b>
<b class="nc">&nbsp;            for(LiftSet ls: w.getCompletedSets()){</b>
<b class="nc">&nbsp;                if(ls.getSets().isEmpty()){</b>
&nbsp;                    continue;
&nbsp;                }else {
<b class="nc">&nbsp;                    if (tf2liftCounter.containsKey(ls.getLift().getTitle())) {</b>
<b class="nc">&nbsp;                        tf2liftCounter.put(ls.getLift().getTitle(), tf2liftCounter.get(ls.getLift().getTitle()) + 1);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        tf2liftCounter.put(ls.getLift().getTitle(), 1);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        Set&lt;String&gt; keys1 = tf1liftCounter.keySet();</b>
<b class="nc">&nbsp;        Set&lt;String&gt; keys2 = tf2liftCounter.keySet();</b>
<b class="nc">&nbsp;        keys1.retainAll(keys2); // Retains only common keys in keys1</b>
&nbsp;
<b class="nc">&nbsp;        if (keys1.isEmpty()) {</b>
<b class="nc">&nbsp;            return null; // No common keys found</b>
&nbsp;        }
&nbsp;
&nbsp;        // Find the key with the highest combined value
<b class="nc">&nbsp;        String maxKey = null;</b>
<b class="nc">&nbsp;        int maxValue = Integer.MIN_VALUE;</b>
&nbsp;
<b class="nc">&nbsp;        for (String key : keys1) {</b>
<b class="nc">&nbsp;            int combinedValue = tf1liftCounter.get(key) + tf2liftCounter.get(key);</b>
<b class="nc">&nbsp;            if (combinedValue &gt; maxValue) {</b>
<b class="nc">&nbsp;                maxValue = combinedValue;</b>
<b class="nc">&nbsp;                maxKey = key;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return maxKey;</b>
&nbsp;    }
&nbsp;    public String getMostPopularMuscleGroup(String username){
<b class="nc">&nbsp;        User u = userRepository.findByUsername(username);</b>
<b class="nc">&nbsp;        Map&lt;String, Integer&gt; muscleCounter = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        for(CompletedWorkout w: u.getCompletedWorkouts()){</b>
<b class="nc">&nbsp;            for(LiftSet ls: w.getCompletedSets()){</b>
<b class="nc">&nbsp;                if(muscleCounter.containsKey(ls.getLift().getMuscleGroup())){</b>
<b class="nc">&nbsp;                    muscleCounter.put(ls.getLift().getMuscleGroup(), muscleCounter.get(ls.getLift().getMuscleGroup()) + 1);</b>
&nbsp;                }else{
<b class="nc">&nbsp;                    muscleCounter.put(ls.getLift().getMuscleGroup(), 1);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return Collections.max(muscleCounter.entrySet(), Map.Entry.comparingByValue()).getKey();</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getRandomPopularLift(String username,String tf1s, String tf1e, String tf2s, String tf2e){
<b class="nc">&nbsp;        List&lt;String&gt; list= completedWorkoutRepository.getLiftsByUserInTwoRange(username, tf1s, tf1e, tf2s, tf2e);</b>
<b class="nc">&nbsp;        Random random = new Random();</b>
<b class="nc">&nbsp;        int randomIndex = random.nextInt(list.size());</b>
<b class="nc">&nbsp;        return list.get(randomIndex);</b>
&nbsp;    }
&nbsp;    public String getRandomPopularMuscleGroup(String username,String tf1s, String tf1e, String tf2s, String tf2e){
<b class="nc">&nbsp;        List&lt;String&gt; list = completedWorkoutRepository.getMuscleGroupsByUserInTwoRange(username, tf1s, tf1e, tf2s, tf2e);</b>
<b class="nc">&nbsp;        Random random = new Random();</b>
<b class="nc">&nbsp;        int randomIndex = random.nextInt(list.size());</b>
&nbsp;        // Return element at random index
<b class="nc">&nbsp;        return list.get(randomIndex);</b>
&nbsp;    }
&nbsp;    public String getRandomLift(String username){
<b class="nc">&nbsp;        List&lt;String&gt; list = completedWorkoutRepository.getLiftsByUser(username);</b>
<b class="nc">&nbsp;        Random random = new Random();</b>
<b class="nc">&nbsp;        int randomIndex = random.nextInt(list.size());</b>
<b class="nc">&nbsp;        return list.get(randomIndex);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-12-11 15:18</div>
</div>
</body>
</html>
